<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Le Bon Guide Immobilier — Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar{width:10px}
    ::-webkit-scrollbar-thumb{background:#d4d4d8;border-radius:9999px}
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <div class="max-w-4xl mx-auto p-4 md:p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">Assistant Immobilier & Travaux</h1>
      <a href="/index.html" class="text-sm underline">⟵ Retour analyse</a>
    </header>

    <section class="mb-3">
      <label class="block text-sm font-medium mb-1">URL de l'annonce</label>
      <div class="flex gap-2">
        <input id="urlInput" type="url" placeholder="https://www.leboncoin.fr/…" class="flex-1 px-3 py-2 rounded-md border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400" />
        <button id="loadBtn" class="px-3 py-2 rounded-md bg-zinc-900 text-white">Charger</button>
      </div>
      <p class="text-xs text-zinc-500 mt-1">Au clic sur “Charger”, l’IA lit la page et lance l’analyse automatiquement.</p>
    </section>

    <main id="chat" class="border border-zinc-200 rounded-lg bg-white h-[65vh] overflow-y-auto p-3 space-y-3"></main>

    <form id="form" class="mt-3 flex gap-2">
      <input id="msg" placeholder="Pose ta question (travaux €/m², risques, négo…)" class="flex-1 px-3 py-2 rounded-md border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-zinc-400" />
      <button class="px-4 py-2 rounded-md bg-zinc-900 text-white">Envoyer</button>
    </form>

    <footer class="text-[11px] text-zinc-500 mt-4">⚠️ Prototype. Vérifie chiffrages/normes auprès de pros (BET, architecte, diagnostiqueur, assureur).</footer>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const form = document.getElementById('form');
    const msgInput = document.getElementById('msg');
    const urlInput = document.getElementById('urlInput');
    const loadBtn = document.getElementById('loadBtn');

    const STORAGE_KEY = 'lbgichat_v2';
    let messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentURL = '';

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }
    function escapeHtml(str){ return str.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function bubble(role, html){
      const wrap = document.createElement('div');
      wrap.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';
      const b = document.createElement('div');
      b.className = 'max-w-[85%] whitespace-pre-wrap text-sm md:text-base rounded-2xl px-4 py-2 shadow ' + (role === 'user' ? 'bg-zinc-900 text-white rounded-br-md' : 'bg-zinc-100 text-zinc-900 rounded-bl-md');
      b.innerHTML = html;
      wrap.appendChild(b); chatEl.appendChild(wrap); chatEl.scrollTop = chatEl.scrollHeight;
    }
    function render(){ chatEl.innerHTML=''; for(const m of messages) bubble(m.role, escapeHtml(m.content)); }

    async function ask(payload){
      const res = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const text = await res.text();
      bubble('assistant', escapeHtml(text));
      messages.push({ role:'assistant', content: text }); save();
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const content = msgInput.value.trim(); if(!content) return;
      messages.push({ role:'user', content }); bubble('user', escapeHtml(content));
      msgInput.value=''; save();
      ask({ messages, url: currentURL });
    });

    // Auto-analyse au clic sur “Charger”
    loadBtn.addEventListener('click', ()=>{
      const u = urlInput.value.trim(); if(!u) return;
      currentURL = u;
      messages.push({ role:'system', content:`[URL] ${u}` });
      save();
      bubble('assistant', 'URL attachée → j’analyse l’annonce…');
      const question = "Analyse l'annonce";
      messages.push({ role:'user', content: question });
      bubble('user', escapeHtml(question)); save();
      ask({ messages, url: currentURL });
    });

    render();
  </script>
</body>
</html>
